<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìä Exam Results Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #3730a3;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-600: #4b5563;
            --gray-800: #1f2937;
            --gray-900: #111827;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        /* Import Section */
        .import-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 25px;
            text-align: center;
        }
        
        .import-section h2 {
            margin-bottom: 20px;
            color: var(--gray-800);
        }
        
        .file-input-wrapper {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .file-input-wrapper input[type="file"] {
            padding: 10px;
            border: 2px dashed var(--gray-300);
            border-radius: 8px;
            cursor: pointer;
        }
        
        .file-input-wrapper input[type="file"]:hover {
            border-color: var(--primary);
        }
        
        .import-btn {
            padding: 12px 30px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .import-btn:hover {
            background: var(--primary-dark);
        }
        
        .import-btn:disabled {
            background: var(--gray-300);
            cursor: not-allowed;
        }
        
        .loaded-files {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }
        
        .file-badge {
            background: var(--gray-100);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            color: var(--gray-800);
        }
        
        .file-badge.loaded {
            background: #d1fae5;
            color: #065f46;
        }
        
        /* Dashboard Content (hidden until data is loaded) */
        .dashboard-content {
            display: none;
        }
        
        .dashboard-content.visible {
            display: block;
        }
        
        /* Filter Bar */
        .filter-bar {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 25px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-group label {
            font-size: 0.85rem;
            color: var(--gray-600);
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .filter-group select,
        .filter-group input {
            padding: 10px 12px;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            font-size: 0.95rem;
            transition: border-color 0.2s;
        }
        
        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        /* Tab Navigation */
        .tab-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .tab-btn {
            padding: 12px 24px;
            border: none;
            background: rgba(255,255,255,0.2);
            color: white;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }
        
        .tab-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .tab-btn.active {
            background: white;
            color: var(--primary);
        }
        
        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }
        
        .card h2 {
            font-size: 1.3rem;
            color: var(--gray-800);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            text-align: center;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: var(--gray-600);
        }
        
        /* Student Grid */
        .student-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }
        
        .student-card {
            background: var(--gray-50);
            border-radius: 10px;
            padding: 20px;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            position: relative;
        }
        
        .student-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .student-card.expanded {
            background: white;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .student-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .student-name {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--gray-800);
        }
        
        .student-class {
            font-size: 0.8rem;
            color: var(--gray-600);
            background: var(--gray-200);
            padding: 3px 10px;
            border-radius: 15px;
        }
        
        .student-score {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .score-bar {
            flex: 1;
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .score-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        .score-value {
            font-weight: 600;
            font-size: 1rem;
            min-width: 45px;
            text-align: right;
        }
        
        .missed-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }
        
        .missed-tags .show-more-tags {
            display: none;
        }
        
        .missed-tags.collapsed .tag:nth-child(n+4) {
            display: none;
        }
        
        .missed-tags.collapsed .show-more-tags {
            display: inline-flex;
        }
        
        .missed-tags-full {
            display: none;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--gray-200);
        }
        
        .student-card.expanded .missed-tags-full {
            display: block;
        }
        
        .tag {
            font-size: 0.75rem;
            padding: 4px 10px;
            background: #fee2e2;
            color: #991b1b;
            border-radius: 12px;
        }
        
        .show-more-tags {
            font-size: 0.75rem;
            padding: 4px 10px;
            background: var(--gray-300);
            color: var(--gray-600);
            border-radius: 12px;
            cursor: pointer;
        }
        
        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }
        
        th {
            background: var(--gray-50);
            font-weight: 600;
            color: var(--gray-800);
        }
        
        tr:hover {
            background: var(--gray-50);
        }
        
        .accuracy-bar {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .accuracy-bar-bg {
            flex: 1;
            height: 10px;
            background: var(--gray-200);
            border-radius: 5px;
            overflow: hidden;
        }
        
        .accuracy-bar-fill {
            height: 100%;
            border-radius: 5px;
        }
        
        .accuracy-value {
            min-width: 50px;
            text-align: right;
            font-weight: 500;
        }
        
        /* Tab Content */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Chart Containers */
        .chart-container {
            height: 300px;
            position: relative;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
        }
        
        /* Edit Tab Styles */
        .edit-table {
            font-size: 0.85rem;
        }
        
        .edit-table th, .edit-table td {
            padding: 8px 10px;
            text-align: center;
        }
        
        .edit-table th:first-child, .edit-table td:first-child {
            text-align: left;
            position: sticky;
            left: 0;
            background: white;
            z-index: 1;
        }
        
        .edit-table input {
            width: 30px;
            text-align: center;
            padding: 4px;
            border: 1px solid var(--gray-300);
            border-radius: 4px;
            text-transform: uppercase;
        }
        
        .edit-table input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .table-wrapper {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .export-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .export-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .export-btn.primary {
            background: var(--primary);
            color: white;
        }
        
        .export-btn.primary:hover {
            background: var(--primary-dark);
        }
        
        .export-btn.secondary {
            background: var(--gray-200);
            color: var(--gray-800);
        }
        
        .export-btn.secondary:hover {
            background: var(--gray-300);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8rem;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .filter-bar {
                grid-template-columns: 1fr;
            }
        }
        
        /* Color utilities */
        .fill-success { background: var(--success); }
        .fill-warning { background: var(--warning); }
        .fill-danger { background: var(--danger); }
        .text-success { color: var(--success); }
        .text-warning { color: var(--warning); }
        .text-danger { color: var(--danger); }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Exam Results Dashboard</h1>
            <p>Import CSV files to visualize exam results</p>
        </div>
        
        <!-- Import Section -->
        <div class="import-section" id="importSection">
            <h2>üìÅ Import CSV Files</h2>
            <p style="color: var(--gray-600); margin-bottom: 20px;">
                Select one or more CSV files generated by the auto-grader (e.g., results_6o.csv, results_7oA.csv)
            </p>
            <div class="file-input-wrapper">
                <input type="file" id="csvInput" accept=".csv" multiple>
                <button class="import-btn" id="loadBtn" onclick="loadCSVFiles()">üì• Load Data</button>
            </div>
            <div class="loaded-files" id="loadedFiles"></div>
        </div>
        
        <!-- Dashboard Content -->
        <div class="dashboard-content" id="dashboardContent">
            <!-- Filter Bar -->
            <div class="filter-bar">
                <div class="filter-group">
                    <label for="classFilter">üìö Class</label>
                    <select id="classFilter">
                        <option value="all">All Classes</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="minScore">üìä Min Score</label>
                    <input type="number" id="minScore" min="0" max="25" value="0">
                </div>
                <div class="filter-group">
                    <label for="maxScore">üìä Max Score</label>
                    <input type="number" id="maxScore" min="0" max="25" value="25">
                </div>
                <div class="filter-group">
                    <label for="searchInput">üîç Search Student</label>
                    <input type="text" id="searchInput" placeholder="Type name...">
                </div>
            </div>
            
            <!-- Tab Navigation -->
            <div class="tab-nav">
                <button class="tab-btn active" data-tab="overview">üìà Overview</button>
                <button class="tab-btn" data-tab="students">üë®‚Äçüéì Students</button>
                <button class="tab-btn" data-tab="questions">üìù Questions</button>
                <button class="tab-btn" data-tab="tags">üè∑Ô∏è Tags</button>
                <button class="tab-btn" data-tab="edit">‚úèÔ∏è Edit Results</button>
            </div>
            
            <!-- Overview Tab -->
            <div id="overview" class="tab-content active">
                <div class="stats-grid" id="statsGrid"></div>
                
                <div class="charts-grid">
                    <div class="card">
                        <h2>üìä Score Distribution</h2>
                        <div class="chart-container">
                            <canvas id="scoreDistChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h2>üìà Class Comparison</h2>
                        <div class="chart-container">
                            <canvas id="classCompChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Students Tab -->
            <div id="students" class="tab-content">
                <div class="card">
                    <h2>üë®‚Äçüéì Student Results</h2>
                    <div class="student-grid" id="studentGrid"></div>
                </div>
            </div>
            
            <!-- Questions Tab -->
            <div id="questions" class="tab-content">
                <div class="card">
                    <h2>üìù Question Accuracy</h2>
                    <div class="chart-container" style="height: 400px;">
                        <canvas id="questionChart"></canvas>
                    </div>
                </div>
                
                <div class="card">
                    <h2>üìã Question Details</h2>
                    <div class="table-wrapper">
                        <table id="questionTable">
                            <thead>
                                <tr>
                                    <th>Question</th>
                                    <th>Accuracy</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Tags Tab -->
            <div id="tags" class="tab-content">
                <div class="card">
                    <h2>üè∑Ô∏è Tag Performance</h2>
                    <div class="chart-container" style="height: 400px;">
                        <canvas id="tagChart"></canvas>
                    </div>
                </div>
                
                <div class="card">
                    <h2>üìã Tag Details</h2>
                    <div class="table-wrapper">
                        <table id="tagTable">
                            <thead>
                                <tr>
                                    <th>Tag</th>
                                    <th>Accuracy</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Edit Tab -->
            <div id="edit" class="tab-content">
                <div class="card">
                    <h2>‚úèÔ∏è Edit & Export Results</h2>
                    <div class="export-buttons">
                        <button class="export-btn primary" onclick="exportCSV()">üì• Export CSV</button>
                        <button class="export-btn secondary" onclick="exportJSON()">üì• Export JSON</button>
                    </div>
                    <div class="table-wrapper">
                        <table class="edit-table" id="editTable">
                            <thead>
                                <tr id="editTableHeader"></tr>
                            </thead>
                            <tbody id="editTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Global data storage
        let allStudents = [];
        let loadedClasses = new Set();
        
        // Chart instances storage
        let chartInstances = {
            scoreDistChart: null,
            classCompChart: null,
            questionChart: null,
            tagChart: null
        };
        
        // State
        let currentFilters = {
            classFilter: 'all',
            minScore: 0,
            maxScore: 25,
            search: ''
        };
        
        // Parse CSV content
        function parseCSV(content, className) {
            const lines = content.trim().split('\n');
            if (lines.length < 2) return [];
            
            const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
            const students = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length < headers.length) continue;
                
                const student = {
                    class: className,
                    answers: {}
                };
                
                headers.forEach((header, idx) => {
                    const value = values[idx];
                    
                    if (header === 'Name') {
                        student.name = value;
                    } else if (header === 'Total Score') {
                        student.score = parseInt(value) || 0;
                        student.total = 25;
                        student.percentage = Math.round((student.score / 25) * 100 * 10) / 10;
                    } else if (header === 'Missed Tags') {
                        student.missed_tags = value && value !== 'None' 
                            ? value.split(',').map(t => t.trim()).filter(t => t)
                            : [];
                    } else if (header.startsWith('Q')) {
                        const qNum = parseInt(header.replace('Q', ''));
                        if (!isNaN(qNum)) {
                            student.answers[qNum] = value || '';
                        }
                    }
                });
                
                if (student.name) {
                    students.push(student);
                }
            }
            
            return students;
        }
        
        // Parse a single CSV line handling quoted values
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            
            return result;
        }
        
        // Load CSV files
        async function loadCSVFiles() {
            const fileInput = document.getElementById('csvInput');
            const files = fileInput.files;
            
            if (files.length === 0) {
                alert('Please select at least one CSV file.');
                return;
            }
            
            const loadedFilesDiv = document.getElementById('loadedFiles');
            loadedFilesDiv.innerHTML = '';
            
            for (const file of files) {
                const content = await file.text();
                
                // Extract class name from filename (e.g., results_6o.csv -> 6o)
                let className = file.name.replace(/^results_/, '').replace(/\.csv$/i, '');
                
                const students = parseCSV(content, className);
                
                // Remove existing students from this class before adding new ones
                allStudents = allStudents.filter(s => s.class !== className);
                allStudents.push(...students);
                loadedClasses.add(className);
                
                // Show loaded file badge
                const badge = document.createElement('span');
                badge.className = 'file-badge loaded';
                badge.textContent = `${file.name} (${students.length} students)`;
                loadedFilesDiv.appendChild(badge);
            }
            
            // Sort all students alphabetically
            allStudents.sort((a, b) => a.name.localeCompare(b.name));
            
            // Update class filter options
            updateClassFilter();
            
            // Show dashboard
            document.getElementById('dashboardContent').classList.add('visible');
            
            // Initialize all views
            updateAll();
        }
        
        // Update class filter dropdown
        function updateClassFilter() {
            const select = document.getElementById('classFilter');
            select.innerHTML = '<option value="all">All Classes</option>';
            
            const sortedClasses = Array.from(loadedClasses).sort();
            sortedClasses.forEach(cls => {
                const option = document.createElement('option');
                option.value = cls;
                option.textContent = cls;
                select.appendChild(option);
            });
        }
        
        // Get filtered students
        function getFilteredStudents() {
            return allStudents.filter(s => {
                if (currentFilters.classFilter !== 'all' && s.class !== currentFilters.classFilter) return false;
                if (s.score < currentFilters.minScore || s.score > currentFilters.maxScore) return false;
                if (currentFilters.search && !s.name.toLowerCase().includes(currentFilters.search.toLowerCase())) return false;
                return true;
            });
        }
        
        // Calculate statistics
        function getStatistics() {
            const students = getFilteredStudents();
            const classes = new Set(students.map(s => s.class));
            
            // Question accuracy
            const questionStats = {};
            for (let q = 1; q <= 25; q++) {
                questionStats[q] = { correct: 0, total: 0 };
            }
            
            // Tag accuracy  
            const tagStats = {};
            
            students.forEach(s => {
                // Count non-empty answers as attempts
                for (let q = 1; q <= 25; q++) {
                    if (s.answers[q]) {
                        questionStats[q].total++;
                        // We don't have the answer key, so we calculate from score
                    }
                }
                
                // Track tags - all tags not in missed_tags are correct
                s.missed_tags.forEach(tag => {
                    if (!tagStats[tag]) tagStats[tag] = { correct: 0, incorrect: 0 };
                    tagStats[tag].incorrect++;
                });
            });
            
            return {
                totalStudents: students.length,
                classCount: classes.size,
                avgScore: students.length > 0 
                    ? (students.reduce((a, s) => a + s.score, 0) / students.length).toFixed(1)
                    : 0,
                avgPercentage: students.length > 0
                    ? (students.reduce((a, s) => a + s.percentage, 0) / students.length).toFixed(1)
                    : 0,
                questionStats,
                tagStats,
                students
            };
        }
        
        // Update all views
        function updateAll() {
            updateStats();
            updateStudentGrid();
            updateQuestionTable();
            updateTagTable();
            updateEditTable();
            updateCharts();
        }
        
        // Destroy and recreate a chart
        function recreateChart(canvasId, chartConfig) {
            const canvas = document.getElementById(canvasId);
            
            if (chartInstances[canvasId]) {
                chartInstances[canvasId].destroy();
                chartInstances[canvasId] = null;
            }
            
            chartInstances[canvasId] = new Chart(canvas, chartConfig);
            return chartInstances[canvasId];
        }
        
        // Update stats cards
        function updateStats() {
            const stats = getStatistics();
            
            document.getElementById('statsGrid').innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${stats.totalStudents}</div>
                    <div class="stat-label">Total Students</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.classCount}</div>
                    <div class="stat-label">Classes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.avgScore}</div>
                    <div class="stat-label">Average Score</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.avgPercentage}%</div>
                    <div class="stat-label">Average Percentage</div>
                </div>
            `;
        }
        
        // Update student grid
        function updateStudentGrid() {
            const students = getFilteredStudents();
            const grid = document.getElementById('studentGrid');
            
            grid.innerHTML = students.map(s => {
                const fillClass = s.percentage >= 70 ? 'fill-success' : s.percentage >= 50 ? 'fill-warning' : 'fill-danger';
                const textClass = s.percentage >= 70 ? 'text-success' : s.percentage >= 50 ? 'text-warning' : 'text-danger';
                
                const tags = s.missed_tags;
                const visibleTags = tags.slice(0, 3);
                const hiddenCount = tags.length - 3;
                
                const tagsHtml = tags.length > 0 
                    ? `<div class="missed-tags collapsed">
                         ${visibleTags.map(t => `<span class="tag">${t}</span>`).join('')}
                         ${hiddenCount > 0 ? `<span class="show-more-tags">+${hiddenCount} more</span>` : ''}
                       </div>
                       <div class="missed-tags-full">
                         <strong>All Missed Tags:</strong><br>
                         ${tags.map(t => `<span class="tag">${t}</span>`).join(' ')}
                       </div>`
                    : '<div class="missed-tags"><span style="color: var(--success); font-size: 0.85rem;">‚úì No missed tags</span></div>';
                
                return `
                    <div class="student-card" onclick="toggleStudentCard(this)">
                        <div class="student-header">
                            <span class="student-name">${s.name}</span>
                            <span class="student-class">${s.class}</span>
                        </div>
                        <div class="student-score">
                            <div class="score-bar">
                                <div class="score-fill ${fillClass}" style="width: ${s.percentage}%"></div>
                            </div>
                            <span class="score-value ${textClass}">${s.score}/25</span>
                        </div>
                        ${tagsHtml}
                    </div>
                `;
            }).join('');
        }
        
        function toggleStudentCard(card) {
            card.classList.toggle('expanded');
        }
        
        // Update charts
        function updateCharts() {
            const students = getFilteredStudents();
            
            // Score Distribution
            const scoreCounts = Array(26).fill(0);
            students.forEach(s => scoreCounts[s.score]++);
            
            recreateChart('scoreDistChart', {
                type: 'bar',
                data: {
                    labels: Array.from({length: 26}, (_, i) => i.toString()),
                    datasets: [{
                        label: 'Students',
                        data: scoreCounts,
                        backgroundColor: 'rgba(79, 70, 229, 0.7)',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Number of Students' } },
                        x: { title: { display: true, text: 'Score' } }
                    }
                }
            });
            
            // Class Comparison
            const classSummary = {};
            students.forEach(s => {
                if (!classSummary[s.class]) classSummary[s.class] = { total: 0, count: 0 };
                classSummary[s.class].total += s.score;
                classSummary[s.class].count++;
            });
            
            const classNames = Object.keys(classSummary).sort();
            const classAvgs = classNames.map(c => classSummary[c].total / classSummary[c].count);
            
            recreateChart('classCompChart', {
                type: 'bar',
                data: {
                    labels: classNames,
                    datasets: [{
                        label: 'Average Score',
                        data: classAvgs,
                        backgroundColor: ['rgba(16, 185, 129, 0.7)', 'rgba(245, 158, 11, 0.7)', 'rgba(239, 68, 68, 0.7)', 'rgba(79, 70, 229, 0.7)'],
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, max: 25, title: { display: true, text: 'Average Score' } } }
                }
            });
            
            // Question accuracy - estimate from # of answers provided
            const questionData = Array.from({length: 25}, (_, i) => {
                const q = i + 1;
                let answeredCount = 0;
                students.forEach(s => { if (s.answers[q]) answeredCount++; });
                // Without answer key, we show % who answered each question
                return students.length > 0 ? (answeredCount / students.length * 100) : 0;
            });
            
            recreateChart('questionChart', {
                type: 'line',
                data: {
                    labels: Array.from({length: 25}, (_, i) => `Q${i + 1}`),
                    datasets: [{
                        label: '% Answered',
                        data: questionData,
                        borderColor: '#4f46e5',
                        backgroundColor: '#4f46e5',
                        tension: 0.3,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, max: 100, title: { display: true, text: '% Answered' } } }
                }
            });
            
            // Tag chart - show tags with most misses
            const tagCounts = {};
            students.forEach(s => {
                s.missed_tags.forEach(tag => {
                    tagCounts[tag] = (tagCounts[tag] || 0) + 1;
                });
            });
            
            const sortedTags = Object.entries(tagCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 15);
            
            const tagLabels = sortedTags.map(t => t[0]);
            const tagValues = sortedTags.map(t => {
                // Calculate % who got this tag wrong
                return students.length > 0 ? (100 - (t[1] / students.length * 100)) : 100;
            });
            
            recreateChart('tagChart', {
                type: 'bar',
                data: {
                    labels: tagLabels,
                    datasets: [{
                        label: 'Success Rate %',
                        data: tagValues,
                        backgroundColor: tagValues.map(v => v >= 70 ? 'rgba(16, 185, 129, 0.7)' : v >= 50 ? 'rgba(245, 158, 11, 0.7)' : 'rgba(239, 68, 68, 0.7)'),
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: { legend: { display: false } },
                    scales: { x: { beginAtZero: true, max: 100, title: { display: true, text: 'Success Rate %' } } }
                }
            });
        }
        
        // Update question table
        function updateQuestionTable() {
            const students = getFilteredStudents();
            const tbody = document.querySelector('#questionTable tbody');
            
            let rows = '';
            for (let q = 1; q <= 25; q++) {
                let answeredCount = 0;
                students.forEach(s => { if (s.answers[q]) answeredCount++; });
                const acc = students.length > 0 ? (answeredCount / students.length * 100) : 0;
                const fillClass = acc >= 70 ? 'fill-success' : acc >= 50 ? 'fill-warning' : 'fill-danger';
                
                rows += `
                    <tr>
                        <td>Question ${q}</td>
                        <td>
                            <div class="accuracy-bar">
                                <div class="accuracy-bar-bg">
                                    <div class="accuracy-bar-fill ${fillClass}" style="width: ${acc}%"></div>
                                </div>
                                <span class="accuracy-value">${acc.toFixed(1)}%</span>
                            </div>
                        </td>
                    </tr>
                `;
            }
            tbody.innerHTML = rows;
        }
        
        // Update tag table
        function updateTagTable() {
            const students = getFilteredStudents();
            const tbody = document.querySelector('#tagTable tbody');
            
            // Count tag misses
            const tagCounts = {};
            students.forEach(s => {
                s.missed_tags.forEach(tag => {
                    tagCounts[tag] = (tagCounts[tag] || 0) + 1;
                });
            });
            
            // Sort by miss count (ascending = best first)
            const sortedTags = Object.entries(tagCounts).sort((a, b) => a[1] - b[1]);
            
            tbody.innerHTML = sortedTags.map(([tag, misses]) => {
                const acc = students.length > 0 ? (100 - (misses / students.length * 100)) : 100;
                const fillClass = acc >= 70 ? 'fill-success' : acc >= 50 ? 'fill-warning' : 'fill-danger';
                
                return `
                    <tr>
                        <td>${tag}</td>
                        <td>
                            <div class="accuracy-bar">
                                <div class="accuracy-bar-bg">
                                    <div class="accuracy-bar-fill ${fillClass}" style="width: ${acc}%"></div>
                                </div>
                                <span class="accuracy-value">${acc.toFixed(1)}%</span>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // Update edit table
        function updateEditTable() {
            const students = getFilteredStudents();
            const headerRow = document.getElementById('editTableHeader');
            const tbody = document.getElementById('editTableBody');
            
            headerRow.innerHTML = '<th>Name</th><th>Class</th><th>Score</th>' + 
                Array.from({length: 25}, (_, i) => `<th>Q${i+1}</th>`).join('');
            
            tbody.innerHTML = students.map((s, idx) => {
                const answerCells = Array.from({length: 25}, (_, i) => {
                    const qNum = i + 1;
                    const answer = s.answers[qNum] || '';
                    return `<td><input type="text" maxlength="1" value="${answer}" data-student="${idx}" data-question="${qNum}" onchange="updateAnswer(this)"></td>`;
                }).join('');
                
                return `<tr>
                    <td>${s.name}</td>
                    <td>${s.class}</td>
                    <td id="score-${idx}">${s.score}</td>
                    ${answerCells}
                </tr>`;
            }).join('');
        }
        
        function updateAnswer(input) {
            const studentIdx = parseInt(input.dataset.student);
            const qNum = parseInt(input.dataset.question);
            const newValue = input.value.toUpperCase();
            
            if (newValue && !['A', 'B', 'C', 'D', 'E', ''].includes(newValue)) {
                input.value = '';
                return;
            }
            
            const students = getFilteredStudents();
            const student = students[studentIdx];
            
            if (newValue) {
                student.answers[qNum] = newValue;
            } else {
                delete student.answers[qNum];
            }
            
            // Update in allStudents too
            const original = allStudents.find(s => s.name === student.name && s.class === student.class);
            if (original) {
                if (newValue) {
                    original.answers[qNum] = newValue;
                } else {
                    delete original.answers[qNum];
                }
            }
            
            input.value = newValue;
        }
        
        function exportCSV() {
            const students = getFilteredStudents();
            const headers = ['Name', 'Class', 'Total Score', 'Missed Tags', ...Array.from({length: 25}, (_, i) => `Q${i+1}`)];
            
            const rows = students.map(s => {
                const answers = Array.from({length: 25}, (_, i) => s.answers[i+1] || '');
                return [s.name, s.class, s.score, s.missed_tags.join('; '), ...answers];
            });
            
            const csv = [headers.join(','), ...rows.map(r => r.map(c => `"${c}"`).join(','))].join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'exam_results_export.csv';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function exportJSON() {
            const students = getFilteredStudents();
            const json = JSON.stringify(students, null, 2);
            
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'exam_results_export.json';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                btn.classList.add('active');
                document.getElementById(btn.dataset.tab).classList.add('active');
            });
        });
        
        // Filter listeners
        document.getElementById('classFilter').addEventListener('change', (e) => {
            currentFilters.classFilter = e.target.value;
            updateAll();
        });
        
        document.getElementById('minScore').addEventListener('input', (e) => {
            currentFilters.minScore = parseInt(e.target.value) || 0;
            updateAll();
        });
        
        document.getElementById('maxScore').addEventListener('input', (e) => {
            currentFilters.maxScore = parseInt(e.target.value) || 25;
            updateAll();
        });
        
        document.getElementById('searchInput').addEventListener('input', (e) => {
            currentFilters.search = e.target.value;
            updateAll();
        });
    </script>
</body>
</html>
